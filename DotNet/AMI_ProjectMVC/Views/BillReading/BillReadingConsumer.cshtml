@{
    ViewData["Title"] = "My Bills";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}


<div class="container mt-5">
    <h3 class="mb-4"><i class="bi bi-cash-stack"></i> My Bills</h3>

    <div class="table-responsive shadow-sm rounded">
        <table class="table table-bordered table-hover align-middle text-center mb-0">
            <thead class="table-dark text-white">
                <tr>
                    <th>Bill ID</th>
                    <th>Billing Month</th>
                    <th>Tariff Type</th>
                    <th>Total Consumption (kWh)</th>
                    <th>Total Bill (₹)</th>
                    <th>Remaining Balance (₹)</th> <!-- ✅ New column -->
                    <th>Status</th>
                    <th>Generated Date</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="billReadingsTableBody">
                <tr><td colspan="9" class="text-muted">Loading your bills...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- ✅ Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="paymentModalLabel">
                    <i class="bi bi-credit-card"></i> Pay Bill
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-semibold">Bill ID</label>
                    <input type="text" id="payBillId" class="form-control" readonly />
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Total Bill (₹)</label>
                    <input type="number" id="payTotalBill" class="form-control" readonly />
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Payment Mode</label>
                    <select id="payMode" class="form-select">
                        <option value="UPI">UPI</option>
                        <option value="Credit Card">Credit Card</option>
                        <option value="Debit Card">Debit Card</option>
                        <option value="NetBanking">Net Banking</option>
                        <option value="Cash">Cash</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Amount Paying (₹)</label>
                    <input type="number" id="payAmount" class="form-control" min="0" />
                </div>

                <div class="alert alert-info text-center fw-bold" id="remainingBalance">
                    Remaining Balance: ₹<span id="balanceValue">0</span>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmPaymentBtn">Confirm Payment</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    const apiBase = "https://localhost:7267/api";
    const token = localStorage.getItem("jwtToken");
    const consumerId = localStorage.getItem("consumerId");
    let selectedBill = null;
    const paymentModal = new bootstrap.Modal(document.getElementById("paymentModal"));

    $(document).ready(() => {
      loadBills();

      // Live balance update
      $("#payAmount").on("input", () => {
        const total = parseFloat($("#payTotalBill").val()) || 0;
        const paid = parseFloat($("#payAmount").val()) || 0;
        const remaining = Math.max(total - paid, 0);
        $("#balanceValue").text(remaining.toFixed(2));
      });

      $("#confirmPaymentBtn").click(async () => {
        await confirmPayment();
      });
    });

    function authHeader() {
      return { Authorization: "Bearer " + token };
    }

    async function loadBills() {
      try {
        const res = await fetch(`${apiBase}/BillReading/ByCustomer/${consumerId}`, {
          headers: authHeader(),
        });
        if (!res.ok) throw new Error("Failed to load bills");

        const bills = await res.json();
        if (!bills.length) {
          $("#billReadingsTableBody").html(
            `<tr><td colspan="9" class="text-muted">No bills found.</td></tr>`
          );
          return;
        }

        let rows = "";
        bills.forEach((b) => {
          const generatedDate = new Date(b.generatedDate).toLocaleString();
          const remainingBalance = (b.remainingBalance ?? (b.totalBill - (b.amountPaid ?? 0))).toFixed(2);
          const payButton =
            remainingBalance > 0
              ? `<button class="btn btn-sm btn-success" onclick="openPaymentModal(${b.billId}, ${b.totalBill}, ${remainingBalance})"><i class="bi bi-credit-card"></i> Pay Now</button>`
              : `<span class="badge bg-success">Paid</span>`;

          rows += `<tr>
                    <td>${b.billId}</td>
                    <td>${b.billingMonth}</td>
                    <td>${b.tariffType}</td>
                    <td>${b.totalConsumption}</td>
                    <td>${b.totalBill.toFixed(2)}</td>
                    <td>${remainingBalance}</td>
                    <td>${remainingBalance > 0 ? "Unpaid" : "Paid"}</td>
                    <td>${generatedDate}</td>
                    <td>${payButton}</td>
                  </tr>`;
        });

        $("#billReadingsTableBody").html(rows);
      } catch (error) {
        alert("Error loading bills: " + error.message);
        console.error(error);
      }
    }

    // 🧾 Open Modal
    function openPaymentModal(billId, totalBill, remainingBalance) {
      selectedBill = { billId, totalBill, remainingBalance };
      $("#payBillId").val(billId);
      $("#payTotalBill").val(remainingBalance);
      $("#payAmount").val(remainingBalance);
      $("#balanceValue").text("0.00");
      paymentModal.show();
    }

    // ✅ Confirm Payment
    async function confirmPayment() {
      if (!selectedBill) return alert("No bill selected!");

      const payAmount = parseFloat($("#payAmount").val()) || 0;
      const payMode = $("#payMode").val();

      if (payAmount <= 0) {
        alert("Please enter a valid payment amount.");
        return;
      }

      try {
        const res = await fetch(`${apiBase}/BillReading/PayBill/${selectedBill.billId}`, {
          method: "PUT",
          headers: { ...authHeader(), "Content-Type": "application/json" },
          body: JSON.stringify({
            amountPaid: payAmount,
            paymentMode: payMode,
            paymentDate: new Date().toISOString(),
          }),
        });

        if (!res.ok) throw new Error("Payment failed!");

        const data = await res.json();
        paymentModal.hide();

        alert(
          `✅ Payment Successful!\n\nBill ID: ${selectedBill.billId}\nAmount Paid: ₹${payAmount}\nPayment Mode: ${payMode}\nDate: ${new Date().toLocaleString()}`
        );

        loadBills();
      } catch (err) {
        console.error(err);
        alert("Error while confirming payment: " + err.message);
      }
    }
</script>
