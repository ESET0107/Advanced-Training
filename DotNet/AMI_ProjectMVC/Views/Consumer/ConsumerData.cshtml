@{
    ViewData["Title"] = "Consumer Data";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

<div class="container mt-4">
    <h3 class="mb-4 fw-bold text-primary">
        <i class="bi bi-person-circle"></i> Consumer Data
    </h3>

    <div class="d-flex justify-content-between mb-3">
        <input type="text" id="searchConsumer" class="form-control w-25" placeholder="Search by name or email" />
        <button class="btn btn-success" id="addConsumerBtn">
            <i class="bi bi-plus-circle"></i> Add Consumer
        </button>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle text-center">
            <thead class="table-dark">
                <tr>
                    <th>Consumer ID</th>
                    <th>Name</th>
                    <th>Address</th>
                    <th>Phone</th>
                    <th>Email</th>
                    <th>Tariff</th>
                    <th>Status</th>
                    <th>Created At</th>
                    <th>Created By</th>
                    <th>Updated At</th>
                    <th>Updated By</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="consumerTableBody"></tbody>
        </table>
    </div>
</div>

<!-- Modal for Add/Edit -->
<div class="modal fade" id="consumerModal" tabindex="-1" aria-labelledby="consumerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="consumerModalLabel">Add Consumer</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <form id="consumerForm" class="row g-3">
                    <input type="hidden" id="consumerId" />

                    <div class="col-md-6">
                        <label class="form-label">Name</label>
                        <input type="text" id="name" class="form-control" required />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Address</label>
                        <input type="text" id="address" class="form-control" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Phone</label>
                        <input type="text" id="phone" class="form-control" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Email</label>
                        <input type="email" id="email" class="form-control" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Tariff</label>
                        <input type="number" id="tariffId" class="form-control" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Status</label>
                        <select id="status" class="form-select">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Created By</label>
                        <input type="text" id="createdBy" class="form-control" value="admin" readonly />
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="saveConsumerBtn" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const apiBase = "https://localhost:7267/api/Consumer";
    const token = localStorage.getItem("jwtToken");
    let consumers = [];

    document.addEventListener("DOMContentLoaded", async () => {
        await loadConsumers();
        document.getElementById("searchConsumer").addEventListener("input", filterConsumers);
        document.getElementById("addConsumerBtn").addEventListener("click", openAddModal);
        document.getElementById("saveConsumerBtn").addEventListener("click", saveConsumer);
    });

    async function loadConsumers() {
        try {
            const res = await fetch(`${apiBase}/AllConsumers`, {
                headers: { "Authorization": `Bearer ${token}` }
            });
            if (!res.ok) throw new Error("Failed to fetch consumer data");
            consumers = await res.json();
            renderTable(consumers);
        } catch (err) {
            alert(err.message);
        }
    }

    function renderTable(data) {
        const tbody = document.getElementById("consumerTableBody");
        tbody.innerHTML = "";

        if (!data || data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="12">No records found</td></tr>`;
            return;
        }

        data.forEach(c => {
            tbody.innerHTML += `
                <tr>
                    <td>${c.consumerId}</td>
                    <td>${c.name}</td>
                    <td>${c.address || "-"}</td>
                    <td>${c.phone || "-"}</td>
                    <td>${c.email || "-"}</td>
                    <td>${c.tariffId}</td>
                    <td>${c.status}</td>
                    <td>${new Date(c.createdAt).toLocaleDateString()}</td>
                    <td>${c.createdBy || "-"}</td>
                    <td>${c.updatedAt ? new Date(c.updatedAt).toLocaleDateString() : "-"}</td>
                    <td>${c.updatedBy || "-"}</td>
                    <td>
                        <button class="btn btn-sm btn-primary me-1" onclick="editConsumer(${c.consumerId})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteConsumer(${c.consumerId})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>`;
        });
    }

    function filterConsumers() {
        const search = document.getElementById("searchConsumer").value.toLowerCase();
        const filtered = consumers.filter(c =>
            c.name.toLowerCase().includes(search) ||
            (c.email && c.email.toLowerCase().includes(search))
        );
        renderTable(filtered);
    }

    function openAddModal() {
        document.getElementById("consumerForm").reset();
        document.getElementById("consumerId").value = "";
        document.getElementById("consumerModalLabel").textContent = "Add Consumer";
        new bootstrap.Modal(document.getElementById("consumerModal")).show();
    }

    function editConsumer(id) {
        const c = consumers.find(x => x.consumerId === id);
        if (!c) return;

        document.getElementById("consumerId").value = c.consumerId;
        document.getElementById("name").value = c.name;
        document.getElementById("address").value = c.address;
        document.getElementById("phone").value = c.phone;
        document.getElementById("email").value = c.email;
        document.getElementById("tariffId").value = c.tariffId;
        document.getElementById("status").value = c.status;
        document.getElementById("createdBy").value = c.createdBy || "admin";

        document.getElementById("consumerModalLabel").textContent = "Edit Consumer";
        new bootstrap.Modal(document.getElementById("consumerModal")).show();
    }

    async function saveConsumer() {
        const id = document.getElementById("consumerId").value;
        const data = {
            consumerId: id ? parseInt(id) : 0,
            name: document.getElementById("name").value,
            address: document.getElementById("address").value,
            phone: document.getElementById("phone").value,
            email: document.getElementById("email").value,
            tariffId: parseInt(document.getElementById("tariffId").value),
            status: document.getElementById("status").value,
            createdAt: new Date().toISOString(),
            createdBy: document.getElementById("createdBy").value,
            updatedAt: new Date().toISOString(),
            updatedBy: "admin"
        };

        const url = id ? `${apiBase}/UpdateConsumers/${id}` : `${apiBase}/addConsumers`;
        const method = id ? "PUT" : "POST";

        try {
            const res = await fetch(url, {
                method,
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });

            if (!res.ok) throw new Error("Failed to save consumer");

            alert("Consumer saved successfully!");
            await loadConsumers();
            bootstrap.Modal.getInstance(document.getElementById("consumerModal")).hide();
        } catch (err) {
            alert(err.message);
        }
    }

    async function deleteConsumer(id) {
        if (!confirm("Are you sure you want to delete this consumer?")) return;

        try {
            const res = await fetch(`${apiBase}/DeleteConsumers/${id}`, {
                method: "DELETE",
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (!res.ok) throw new Error("Failed to delete consumer");

            alert("Consumer deleted successfully!");
            await loadConsumers();
        } catch (err) {
            alert(err.message);
        }
    }
</script>
